import _init_path
import argparse
import datetime
import glob
import os
import re
import time
from pathlib import Path
from easydict import EasyDict
import numpy as np
import torch
from tensorboardX import SummaryWriter

from eval_utils import eval_utils, eval_seg_det_utils
from pcdet.config import cfg, cfg_from_list, cfg_from_yaml_file, log_config_to_file
from pcdet.datasets import build_dataloader
from pcdet.models import build_network
from pcdet.utils import common_utils
from onnx_utils.fuse_conv_bn import fuse_conv_bn
from pcdet.models import load_data_to_gpu

now = datetime.datetime.now()
cur_time = now.strftime("%Y-%m-%d-%H-%M-%S")

def recursive_easydict(d):
    if isinstance(d, dict):
        return EasyDict({k: recursive_easydict(v) for k, v in d.items()})
    return d

def parse_config():
    parser = argparse.ArgumentParser(description='arg parser')
    parser.add_argument('--cfg_file', type=str, default=None, help='specify the config for training')

    parser.add_argument('--batch_size', type=int, default=None, required=False, help='batch size for training')
    parser.add_argument('--workers', type=int, default=4, help='number of workers for dataloader')
    parser.add_argument('--extra_tag', type=str, default='default', help='extra tag for this experiment')
    parser.add_argument('--ckpt', type=str, default=None, help='checkpoint to start from')
    parser.add_argument('--pretrained_model', type=str, default=None, help='pretrained_model')
    parser.add_argument('--launcher', choices=['none', 'pytorch', 'slurm'], default='none')
    parser.add_argument('--tcp_port', type=int, default=18888, help='tcp port for distrbuted training')
    parser.add_argument('--local_rank', type=int, default=0, help='local rank for distributed training')
    parser.add_argument('--set', dest='set_cfgs', default=None, nargs=argparse.REMAINDER,
                        help='set extra config keys if needed')

    parser.add_argument('--max_waiting_mins', type=int, default=30, help='max waiting minutes')
    parser.add_argument('--start_epoch', type=int, default=0, help='')
    parser.add_argument('--eval_tag', type=str, default='default', help='eval tag for this experiment')
    parser.add_argument('--eval_all', action='store_true', default=False, help='whether to evaluate all checkpoints')
    parser.add_argument('--ckpt_dir', type=str, default=None, help='specify a ckpt directory to be evaluated if needed')
    parser.add_argument('--save_to_file', action='store_true', default=False, help='')
    parser.add_argument('--infer_time', action='store_true', default=False, help='calculate inference latency')

    parser.add_argument('--eval_type', type=str, default='det', choices=['det', 'seg_det'])
    parser.add_argument('--sync_bn', action='store_true', default=False, help='whether to use sync bn')
    parser.add_argument('--iou_thresh', type=float, default=0.3, help='iou_thresh to save predict')
    parser.add_argument('--vis_dir', type=str, default=None, help='pred label vis')
    parser.add_argument('--output_folder', type=str, default='output', help='output folder')

    args = parser.parse_args()
    global cfg
    cfg_from_yaml_file(args.cfg_file, cfg)
    cfg = recursive_easydict(cfg)
    cfg.TAG = Path(args.cfg_file).stem
    cfg.EXP_GROUP_PATH = '/'.join(args.cfg_file.split('/')[1:-1])  # remove 'cfgs' and 'xxxx.yaml'

    np.random.seed(1024)

    if args.set_cfgs is not None:
        cfg_from_list(args.set_cfgs, cfg)

    return args, cfg

# Copyright (c) OpenMMLab. All rights reserved.
import argparse
from copy import deepcopy
import time
import mmcv
import os
import torch
import numpy as np
from mmcv import Config, DictAction
from mmcv.parallel import MMDataParallel
from mmcv.runner import load_checkpoint

from collections import OrderedDict
from horizon_plugin_pytorch.quantization import fuse_known_modules,QuantStub
from torch.quantization import DeQuantStub
from horizon_plugin_pytorch.quantization import hbdk4 as hb4
from hbdk4.compiler import convert, save,visualize,compile, hbm_perf,load
from horizon_plugin_pytorch.qat_mode import tricks,ReLUMode
from horizon_plugin_pytorch.dtype import qint8,qint16
from horizon_plugin_pytorch.march import March, set_march
from horizon_plugin_pytorch.quantization.qconfig import QConfig
from horizon_plugin_pytorch.quantization.fake_quantize import FakeQuantize,set_fake_quantize
from horizon_plugin_pytorch.quantization import prepare,PrepareMethod,FakeQuantState
from horizon_plugin_pytorch.quantization.observer_v2 import MinMaxObserver,MSEObserver,FixedScaleObserver
from horizon_plugin_pytorch.quantization import hbdk4 as hb4
from horizon_plugin_pytorch.utils.check_model import check_qat_model
from horizon_plugin_pytorch.quantization.qconfig_template import (
    default_calibration_qconfig_setter,
    calibration_8bit_weight_16bit_act_qconfig_setter,
    ModuleNameQconfigSetter, 
    sensitive_op_calibration_8bit_weight_16bit_act_qconfig_setter,
)
from horizon_plugin_pytorch.quantization.qconfig import (
    default_calib_8bit_weight_16bit_act_fake_quant_qconfig,
    get_default_qconfig,
    get_qconfig,
    default_calib_8bit_fake_quant_qconfig,
) 

class ModelCompiler(object):
    def __init__(self,
                 save_dir,
                 cfg,
                 fuse_conv_bn_flag=True):
        self.save_dir = save_dir
        self.cfg = cfg
        self.device = torch.device("cuda:0")
        self.fuse_conv_bn_flag = fuse_conv_bn_flag
        self.model = self.build_model()
            
    def build_model(self):
        model = build_network(model_cfg=self.cfg.MODEL, num_class=len(self.cfg.CLASS_NAMES), dataset=self.cfg.ONNX_CONFIG)
        model.to(self.device)
        if self.fuse_conv_bn_flag:
            model = fuse_conv_bn(model)
        model.eval()
        return model

    def process(self, checkpoint_path, data_loader, module_list, input_names, output_names, task, model_name):
        march = March.NASH_M
        set_march(march)
        self.model.forward = self.model.forward_qat_onnx
        for i, data in enumerate(data_loader):
            '''
            data dict_keys(['points', 'label', 'metadata', 'frame_id', 'fuse_points', 'fuse_label', 
            'gt_names', 'gt_boxes', 'num_points_in_gt', 'lidar_aug_matrix', 'use_lead_xyz', 
            'voxels', 'voxel_coords', 'voxel_num_points', 'lidar_label', 'anchors', 'batch_size'])
            '''
            load_data_to_gpu(data)
            data = self.model.vfe.vfe_input_prepare(data)
            data = self.model.map_to_bev_module.voxel_coords_prepare(data)
            new_data = {}
            for k in ['vfe_input', 'voxel_coords']:
                new_data[k] = data[k]
            example_inputs_dataloader = (new_data, module_list, output_names, task)
            break

        module_name_to_qconfig = {}
        self.q_model = prepare(self.model,
                                example_inputs_dataloader,
                                qconfig_setter=(
                                    ModuleNameQconfigSetter(module_name_to_qconfig),
                                    calibration_8bit_weight_16bit_act_qconfig_setter,), # 全int16设定
                                method=PrepareMethod.JIT_STRIP)
        set_fake_quantize(self.q_model, FakeQuantState.CALIBRATION)

        #load calib deploy model
        state_dict_calib = torch.load(checkpoint_path, map_location='cuda:0')
        # import ipdb; ipdb.set_trace()
        with open(f"logs/state_dict_calib_{cur_time}_v0.txt", "w") as f:
            # 模型当前 state_dict
            f.write("=== self.q_model.state_dict ===\n")
            for k, v in state_dict_calib.items():
                f.write(f"{k}: {tuple(v.shape)}\n")
        state_dict_calib_new = {}
        for weight_name in state_dict_calib:
            if weight_name.startswith("module."):
                weight_name_new = weight_name[7:]
            else:
                weight_name_new = weight_name
            if weight_name_new in ["_generated_mul_0.activation_post_process.fake_quant_enabled", "_generated_mul_0.activation_post_process.observer_enabled", "_generated_mul_0.activation_post_process.scale", "_generated_mul_0.activation_post_process.zero_point", "_generated_mul_0.activation_post_process.activation_post_process.eps", "_generated_mul_0.activation_post_process.activation_post_process.min_val", "_generated_mul_0.activation_post_process.activation_post_process.max_val", "_generated_mul_1.activation_post_process.fake_quant_enabled", "_generated_mul_1.activation_post_process.observer_enabled", "_generated_mul_1.activation_post_process.scale", "_generated_mul_1.activation_post_process.zero_point", "_generated_mul_1.activation_post_process.activation_post_process.eps", "_generated_mul_1.activation_post_process.activation_post_process.min_val", "_generated_mul_1.activation_post_process.activation_post_process.max_val", "_generated_add_0.activation_post_process.fake_quant_enabled", "_generated_add_0.activation_post_process.observer_enabled", "_generated_add_0.activation_post_process.scale", "_generated_add_0.activation_post_process.zero_point", "_generated_add_0.activation_post_process.activation_post_process.eps", "_generated_add_0.activation_post_process.activation_post_process.min_val", "_generated_add_0.activation_post_process.activation_post_process.max_val", "_generated_div_0.reciprocal.reciprocal.activation_post_process.fake_quant_enabled", "_generated_div_0.reciprocal.reciprocal.activation_post_process.observer_enabled", "_generated_div_0.reciprocal.reciprocal.activation_post_process.scale", "_generated_div_0.reciprocal.reciprocal.activation_post_process.zero_point", "_generated_div_0.reciprocal.reciprocal.activation_post_process.activation_post_process.eps", "_generated_div_0.reciprocal.reciprocal.activation_post_process.activation_post_process.min_val", "_generated_div_0.reciprocal.reciprocal.activation_post_process.activation_post_process.max_val", "_generated_div_0.mul.activation_post_process.fake_quant_enabled", "_generated_div_0.mul.activation_post_process.observer_enabled", "_generated_div_0.mul.activation_post_process.scale", "_generated_div_0.mul.activation_post_process.zero_point", "_generated_div_0.mul.activation_post_process.activation_post_process.eps", "_generated_div_0.mul.activation_post_process.activation_post_process.min_val", "_generated_div_0.mul.activation_post_process.activation_post_process.max_val", "_generated_div_1.reciprocal.reciprocal.activation_post_process.fake_quant_enabled", "_generated_div_1.reciprocal.reciprocal.activation_post_process.observer_enabled", "_generated_div_1.reciprocal.reciprocal.activation_post_process.scale", "_generated_div_1.reciprocal.reciprocal.activation_post_process.zero_point", "_generated_div_1.reciprocal.reciprocal.activation_post_process.activation_post_process.eps", "_generated_div_1.reciprocal.reciprocal.activation_post_process.activation_post_process.min_val", "_generated_div_1.reciprocal.reciprocal.activation_post_process.activation_post_process.max_val", "_generated_div_1.mul.activation_post_process.fake_quant_enabled", "_generated_div_1.mul.activation_post_process.observer_enabled", "_generated_div_1.mul.activation_post_process.scale", "_generated_div_1.mul.activation_post_process.zero_point", "_generated_div_1.mul.activation_post_process.activation_post_process.eps", "_generated_div_1.mul.activation_post_process.activation_post_process.min_val", "_generated_div_1.mul.activation_post_process.activation_post_process.max_val", "_generated_scatter_0.activation_pre_process.0.fake_quant_enabled", "_generated_scatter_0.activation_pre_process.0.observer_enabled", "_generated_scatter_0.activation_pre_process.0.scale", "_generated_scatter_0.activation_pre_process.0.zero_point", "_generated_scatter_0.activation_pre_process.0.activation_post_process.eps", "_generated_scatter_0.activation_pre_process.0.activation_post_process.min_val", "_generated_scatter_0.activation_pre_process.0.activation_post_process.max_val", "_generated_scatter_0.activation_post_process.fake_quant_enabled", "_generated_scatter_0.activation_post_process.observer_enabled", "_generated_scatter_0.activation_post_process.scale", "_generated_scatter_0.activation_post_process.zero_point", "_generated_scatter_0.activation_post_process.activation_post_process.eps", "_generated_scatter_0.activation_post_process.activation_post_process.min_val", "_generated_scatter_0.activation_post_process.activation_post_process.max_val", "_generated_mul_2.activation_post_process.fake_quant_enabled", "_generated_mul_2.activation_post_process.observer_enabled", "_generated_mul_2.activation_post_process.scale", "_generated_mul_2.activation_post_process.zero_point", "_generated_mul_2.activation_post_process.activation_post_process.eps", "_generated_mul_2.activation_post_process.activation_post_process.min_val", "_generated_mul_2.activation_post_process.activation_post_process.max_val", "_generated___setitem___0.activation_post_process.fake_quant_enabled", "_generated___setitem___0.activation_post_process.observer_enabled", "_generated___setitem___0.activation_post_process.scale", "_generated___setitem___0.activation_post_process.zero_point", "_generated___setitem___0.activation_post_process.activation_post_process.eps", "_generated___setitem___0.activation_post_process.activation_post_process.min_val", "_generated___setitem___0.activation_post_process.activation_post_process.max_val", "_generated_mul_3.activation_post_process.fake_quant_enabled", "_generated_mul_3.activation_post_process.observer_enabled", "_generated_mul_3.activation_post_process.scale", "_generated_mul_3.activation_post_process.zero_point", "_generated_mul_3.activation_post_process.activation_post_process.eps", "_generated_mul_3.activation_post_process.activation_post_process.min_val", "_generated_mul_3.activation_post_process.activation_post_process.max_val", "_generated___setitem___1.activation_post_process.fake_quant_enabled", "_generated___setitem___1.activation_post_process.observer_enabled", "_generated___setitem___1.activation_post_process.scale", "_generated___setitem___1.activation_post_process.zero_point", "_generated___setitem___1.activation_post_process.activation_post_process.eps", "_generated___setitem___1.activation_post_process.activation_post_process.min_val", "_generated___setitem___1.activation_post_process.activation_post_process.max_val", "_generated_mul_4.activation_post_process.fake_quant_enabled", "_generated_mul_4.activation_post_process.observer_enabled", "_generated_mul_4.activation_post_process.scale", "_generated_mul_4.activation_post_process.zero_point", "_generated_mul_4.activation_post_process.activation_post_process.eps", "_generated_mul_4.activation_post_process.activation_post_process.min_val", "_generated_mul_4.activation_post_process.activation_post_process.max_val", "_generated___setitem___2.activation_post_process.fake_quant_enabled", "_generated___setitem___2.activation_post_process.observer_enabled", "_generated___setitem___2.activation_post_process.scale", "_generated___setitem___2.activation_post_process.zero_point", "_generated___setitem___2.activation_post_process.activation_post_process.eps", "_generated___setitem___2.activation_post_process.activation_post_process.min_val", "_generated___setitem___2.activation_post_process.activation_post_process.max_val", "_generated_mul_5.activation_post_process.fake_quant_enabled", "_generated_mul_5.activation_post_process.observer_enabled", "_generated_mul_5.activation_post_process.scale", "_generated_mul_5.activation_post_process.zero_point", "_generated_mul_5.activation_post_process.activation_post_process.eps", "_generated_mul_5.activation_post_process.activation_post_process.min_val", "_generated_mul_5.activation_post_process.activation_post_process.max_val", "_generated___setitem___3.activation_post_process.fake_quant_enabled", "_generated___setitem___3.activation_post_process.observer_enabled", "_generated___setitem___3.activation_post_process.scale", "_generated___setitem___3.activation_post_process.zero_point", "_generated___setitem___3.activation_post_process.activation_post_process.eps", "_generated___setitem___3.activation_post_process.activation_post_process.min_val", "_generated___setitem___3.activation_post_process.activation_post_process.max_val", "_generated_mul_6.activation_post_process.fake_quant_enabled", "_generated_mul_6.activation_post_process.observer_enabled", "_generated_mul_6.activation_post_process.scale", "_generated_mul_6.activation_post_process.zero_point", "_generated_mul_6.activation_post_process.activation_post_process.eps", "_generated_mul_6.activation_post_process.activation_post_process.min_val", "_generated_mul_6.activation_post_process.activation_post_process.max_val", "_generated___setitem___4.activation_post_process.fake_quant_enabled", "_generated___setitem___4.activation_post_process.observer_enabled", "_generated___setitem___4.activation_post_process.scale", "_generated___setitem___4.activation_post_process.zero_point", "_generated___setitem___4.activation_post_process.activation_post_process.eps", "_generated___setitem___4.activation_post_process.activation_post_process.min_val", "_generated___setitem___4.activation_post_process.activation_post_process.max_val", "_generated_mul_7.activation_post_process.fake_quant_enabled", "_generated_mul_7.activation_post_process.observer_enabled", "_generated_mul_7.activation_post_process.scale", "_generated_mul_7.activation_post_process.zero_point", "_generated_mul_7.activation_post_process.activation_post_process.eps", "_generated_mul_7.activation_post_process.activation_post_process.min_val", "_generated_mul_7.activation_post_process.activation_post_process.max_val", "_generated___setitem___5.activation_post_process.fake_quant_enabled", "_generated___setitem___5.activation_post_process.observer_enabled", "_generated___setitem___5.activation_post_process.scale", "_generated___setitem___5.activation_post_process.zero_point", "_generated___setitem___5.activation_post_process.activation_post_process.eps", "_generated___setitem___5.activation_post_process.activation_post_process.min_val", "_generated___setitem___5.activation_post_process.activation_post_process.max_val", "_generated_mul_8.activation_post_process.fake_quant_enabled", "_generated_mul_8.activation_post_process.observer_enabled", "_generated_mul_8.activation_post_process.scale", "_generated_mul_8.activation_post_process.zero_point", "_generated_mul_8.activation_post_process.activation_post_process.eps", "_generated_mul_8.activation_post_process.activation_post_process.min_val", "_generated_mul_8.activation_post_process.activation_post_process.max_val", "_generated___setitem___6.activation_post_process.fake_quant_enabled", "_generated___setitem___6.activation_post_process.observer_enabled", "_generated___setitem___6.activation_post_process.scale", "_generated___setitem___6.activation_post_process.zero_point", "_generated___setitem___6.activation_post_process.activation_post_process.eps", "_generated___setitem___6.activation_post_process.activation_post_process.min_val", "_generated___setitem___6.activation_post_process.activation_post_process.max_val", "_generated_mul_9.activation_post_process.fake_quant_enabled", "_generated_mul_9.activation_post_process.observer_enabled", "_generated_mul_9.activation_post_process.scale", "_generated_mul_9.activation_post_process.zero_point", "_generated_mul_9.activation_post_process.activation_post_process.eps", "_generated_mul_9.activation_post_process.activation_post_process.min_val", "_generated_mul_9.activation_post_process.activation_post_process.max_val", "_generated___setitem___7.activation_post_process.fake_quant_enabled", "_generated___setitem___7.activation_post_process.observer_enabled", "_generated___setitem___7.activation_post_process.scale", "_generated___setitem___7.activation_post_process.zero_point", "_generated___setitem___7.activation_post_process.activation_post_process.eps", "_generated___setitem___7.activation_post_process.activation_post_process.min_val", "_generated___setitem___7.activation_post_process.activation_post_process.max_val", "_generated_cos_0.cos.activation_post_process.fake_quant_enabled", "_generated_cos_0.cos.activation_post_process.observer_enabled", "_generated_cos_0.cos.activation_post_process.scale", "_generated_cos_0.cos.activation_post_process.zero_point", "_generated_cos_0.cos.activation_post_process.activation_post_process.eps", "_generated_cos_0.cos.activation_post_process.activation_post_process.min_val", "_generated_cos_0.cos.activation_post_process.activation_post_process.max_val", "_generated_mul_10.activation_post_process.fake_quant_enabled", "_generated_mul_10.activation_post_process.observer_enabled", "_generated_mul_10.activation_post_process.scale", "_generated_mul_10.activation_post_process.zero_point", "_generated_mul_10.activation_post_process.activation_post_process.eps", "_generated_mul_10.activation_post_process.activation_post_process.min_val", "_generated_mul_10.activation_post_process.activation_post_process.max_val", "_generated_sin_0.sin.activation_post_process.fake_quant_enabled", "_generated_sin_0.sin.activation_post_process.observer_enabled", "_generated_sin_0.sin.activation_post_process.scale", "_generated_sin_0.sin.activation_post_process.zero_point", "_generated_sin_0.sin.activation_post_process.activation_post_process.eps", "_generated_sin_0.sin.activation_post_process.activation_post_process.min_val", "_generated_sin_0.sin.activation_post_process.activation_post_process.max_val", "_generated_mul_11.activation_post_process.fake_quant_enabled", "_generated_mul_11.activation_post_process.observer_enabled", "_generated_mul_11.activation_post_process.scale", "_generated_mul_11.activation_post_process.zero_point", "_generated_mul_11.activation_post_process.activation_post_process.eps", "_generated_mul_11.activation_post_process.activation_post_process.min_val", "_generated_mul_11.activation_post_process.activation_post_process.max_val", "_generated_cat_0.activation_post_process.fake_quant_enabled", "_generated_cat_0.activation_post_process.observer_enabled", "_generated_cat_0.activation_post_process.scale", "_generated_cat_0.activation_post_process.zero_point", "_generated_cat_0.activation_post_process.activation_post_process.eps", "_generated_cat_0.activation_post_process.activation_post_process.min_val", "_generated_cat_0.activation_post_process.activation_post_process.max_val", "_generated_cat_1.activation_post_process.fake_quant_enabled", "_generated_cat_1.activation_post_process.observer_enabled", "_generated_cat_1.activation_post_process.scale", "_generated_cat_1.activation_post_process.zero_point", "_generated_cat_1.activation_post_process.activation_post_process.eps", "_generated_cat_1.activation_post_process.activation_post_process.min_val", "_generated_cat_1.activation_post_process.activation_post_process.max_val", "_generated_sub_0.activation_post_process.fake_quant_enabled", "_generated_sub_0.activation_post_process.observer_enabled", "_generated_sub_0.activation_post_process.scale", "_generated_sub_0.activation_post_process.zero_point", "_generated_sub_0.activation_post_process.activation_post_process.eps", "_generated_sub_0.activation_post_process.activation_post_process.min_val", "_generated_sub_0.activation_post_process.activation_post_process.max_val", "_generated_mul_12.activation_post_process.fake_quant_enabled", "_generated_mul_12.activation_post_process.observer_enabled", "_generated_mul_12.activation_post_process.scale", "_generated_mul_12.activation_post_process.zero_point", "_generated_mul_12.activation_post_process.activation_post_process.eps", "_generated_mul_12.activation_post_process.activation_post_process.min_val", "_generated_mul_12.activation_post_process.activation_post_process.max_val", "_generated_mul_13.activation_post_process.fake_quant_enabled", "_generated_mul_13.activation_post_process.observer_enabled", "_generated_mul_13.activation_post_process.scale", "_generated_mul_13.activation_post_process.zero_point", "_generated_mul_13.activation_post_process.activation_post_process.eps", "_generated_mul_13.activation_post_process.activation_post_process.min_val", "_generated_mul_13.activation_post_process.activation_post_process.max_val", "_generated_pow_0.mul.activation_post_process.fake_quant_enabled", "_generated_pow_0.mul.activation_post_process.observer_enabled", "_generated_pow_0.mul.activation_post_process.scale", "_generated_pow_0.mul.activation_post_process.zero_point", "_generated_pow_0.mul.activation_post_process.activation_post_process.eps", "_generated_pow_0.mul.activation_post_process.activation_post_process.min_val", "_generated_pow_0.mul.activation_post_process.activation_post_process.max_val", "_generated_mul_14.activation_post_process.fake_quant_enabled", "_generated_mul_14.activation_post_process.observer_enabled", "_generated_mul_14.activation_post_process.scale", "_generated_mul_14.activation_post_process.zero_point", "_generated_mul_14.activation_post_process.activation_post_process.eps", "_generated_mul_14.activation_post_process.activation_post_process.min_val", "_generated_mul_14.activation_post_process.activation_post_process.max_val", "_generated_sub_1.activation_post_process.fake_quant_enabled", "_generated_sub_1.activation_post_process.observer_enabled", "_generated_sub_1.activation_post_process.scale", "_generated_sub_1.activation_post_process.zero_point", "_generated_sub_1.activation_post_process.activation_post_process.eps", "_generated_sub_1.activation_post_process.activation_post_process.min_val", "_generated_sub_1.activation_post_process.activation_post_process.max_val", "_generated___rsub___0.activation_post_process.fake_quant_enabled", "_generated___rsub___0.activation_post_process.observer_enabled", "_generated___rsub___0.activation_post_process.scale", "_generated___rsub___0.activation_post_process.zero_point", "_generated___rsub___0.activation_post_process.activation_post_process.eps", "_generated___rsub___0.activation_post_process.activation_post_process.min_val", "_generated___rsub___0.activation_post_process.activation_post_process.max_val", "_generated_mul_15.activation_post_process.fake_quant_enabled", "_generated_mul_15.activation_post_process.observer_enabled", "_generated_mul_15.activation_post_process.scale", "_generated_mul_15.activation_post_process.zero_point", "_generated_mul_15.activation_post_process.activation_post_process.eps", "_generated_mul_15.activation_post_process.activation_post_process.min_val", "_generated_mul_15.activation_post_process.activation_post_process.max_val", "_generated_add_1.activation_post_process.fake_quant_enabled", "_generated_add_1.activation_post_process.observer_enabled", "_generated_add_1.activation_post_process.scale", "_generated_add_1.activation_post_process.zero_point", "_generated_add_1.activation_post_process.activation_post_process.eps", "_generated_add_1.activation_post_process.activation_post_process.min_val", "_generated_add_1.activation_post_process.activation_post_process.max_val", "_generated_mul_16.activation_post_process.fake_quant_enabled", "_generated_mul_16.activation_post_process.observer_enabled", "_generated_mul_16.activation_post_process.scale", "_generated_mul_16.activation_post_process.zero_point", "_generated_mul_16.activation_post_process.activation_post_process.eps", "_generated_mul_16.activation_post_process.activation_post_process.min_val", "_generated_mul_16.activation_post_process.activation_post_process.max_val", "_generated_add_2.activation_post_process.fake_quant_enabled", "_generated_add_2.activation_post_process.observer_enabled", "_generated_add_2.activation_post_process.scale", "_generated_add_2.activation_post_process.zero_point", "_generated_add_2.activation_post_process.activation_post_process.eps", "_generated_add_2.activation_post_process.activation_post_process.min_val", "_generated_add_2.activation_post_process.activation_post_process.max_val", "_generated_mul_17.activation_post_process.fake_quant_enabled", "_generated_mul_17.activation_post_process.observer_enabled", "_generated_mul_17.activation_post_process.scale", "_generated_mul_17.activation_post_process.zero_point", "_generated_mul_17.activation_post_process.activation_post_process.eps", "_generated_mul_17.activation_post_process.activation_post_process.min_val", "_generated_mul_17.activation_post_process.activation_post_process.max_val", "_generated_cat_2.activation_post_process.fake_quant_enabled", "_generated_cat_2.activation_post_process.observer_enabled", "_generated_cat_2.activation_post_process.scale", "_generated_cat_2.activation_post_process.zero_point", "_generated_cat_2.activation_post_process.activation_post_process.eps", "_generated_cat_2.activation_post_process.activation_post_process.min_val", "_generated_cat_2.activation_post_process.activation_post_process.max_val", "_generated_mul_18.activation_post_process.fake_quant_enabled", "_generated_mul_18.activation_post_process.observer_enabled", "_generated_mul_18.activation_post_process.scale", "_generated_mul_18.activation_post_process.zero_point", "_generated_mul_18.activation_post_process.activation_post_process.eps", "_generated_mul_18.activation_post_process.activation_post_process.min_val", "_generated_mul_18.activation_post_process.activation_post_process.max_val", "_generated___setitem___8.activation_post_process.fake_quant_enabled", "_generated___setitem___8.activation_post_process.observer_enabled", "_generated___setitem___8.activation_post_process.scale", "_generated___setitem___8.activation_post_process.zero_point", "_generated___setitem___8.activation_post_process.activation_post_process.eps", "_generated___setitem___8.activation_post_process.activation_post_process.min_val", "_generated___setitem___8.activation_post_process.activation_post_process.max_val", "_generated_mul_19.activation_post_process.fake_quant_enabled", "_generated_mul_19.activation_post_process.observer_enabled", "_generated_mul_19.activation_post_process.scale", "_generated_mul_19.activation_post_process.zero_point", "_generated_mul_19.activation_post_process.activation_post_process.eps", "_generated_mul_19.activation_post_process.activation_post_process.min_val", "_generated_mul_19.activation_post_process.activation_post_process.max_val", "_generated___setitem___9.activation_post_process.fake_quant_enabled", "_generated___setitem___9.activation_post_process.observer_enabled", "_generated___setitem___9.activation_post_process.scale", "_generated___setitem___9.activation_post_process.zero_point", "_generated___setitem___9.activation_post_process.activation_post_process.eps", "_generated___setitem___9.activation_post_process.activation_post_process.min_val", "_generated___setitem___9.activation_post_process.activation_post_process.max_val", "_generated_mul_20.activation_post_process.fake_quant_enabled", "_generated_mul_20.activation_post_process.observer_enabled", "_generated_mul_20.activation_post_process.scale", "_generated_mul_20.activation_post_process.zero_point", "_generated_mul_20.activation_post_process.activation_post_process.eps", "_generated_mul_20.activation_post_process.activation_post_process.min_val", "_generated_mul_20.activation_post_process.activation_post_process.max_val", "_generated___setitem___10.activation_post_process.fake_quant_enabled", "_generated___setitem___10.activation_post_process.observer_enabled", "_generated___setitem___10.activation_post_process.scale", "_generated___setitem___10.activation_post_process.zero_point", "_generated___setitem___10.activation_post_process.activation_post_process.eps", "_generated___setitem___10.activation_post_process.activation_post_process.min_val", "_generated___setitem___10.activation_post_process.activation_post_process.max_val", "_generated_mul_21.activation_post_process.fake_quant_enabled", "_generated_mul_21.activation_post_process.observer_enabled", "_generated_mul_21.activation_post_process.scale", "_generated_mul_21.activation_post_process.zero_point", "_generated_mul_21.activation_post_process.activation_post_process.eps", "_generated_mul_21.activation_post_process.activation_post_process.min_val", "_generated_mul_21.activation_post_process.activation_post_process.max_val", "_generated___setitem___11.activation_post_process.fake_quant_enabled", "_generated___setitem___11.activation_post_process.observer_enabled", "_generated___setitem___11.activation_post_process.scale", "_generated___setitem___11.activation_post_process.zero_point", "_generated___setitem___11.activation_post_process.activation_post_process.eps", "_generated___setitem___11.activation_post_process.activation_post_process.min_val", "_generated___setitem___11.activation_post_process.activation_post_process.max_val", "_generated_mul_22.activation_post_process.fake_quant_enabled", "_generated_mul_22.activation_post_process.observer_enabled", "_generated_mul_22.activation_post_process.scale", "_generated_mul_22.activation_post_process.zero_point", "_generated_mul_22.activation_post_process.activation_post_process.eps", "_generated_mul_22.activation_post_process.activation_post_process.min_val", "_generated_mul_22.activation_post_process.activation_post_process.max_val", "_generated___setitem___12.activation_post_process.fake_quant_enabled", "_generated___setitem___12.activation_post_process.observer_enabled", "_generated___setitem___12.activation_post_process.scale", "_generated___setitem___12.activation_post_process.zero_point", "_generated___setitem___12.activation_post_process.activation_post_process.eps", "_generated___setitem___12.activation_post_process.activation_post_process.min_val", "_generated___setitem___12.activation_post_process.activation_post_process.max_val", "_generated_mul_23.activation_post_process.fake_quant_enabled", "_generated_mul_23.activation_post_process.observer_enabled", "_generated_mul_23.activation_post_process.scale", "_generated_mul_23.activation_post_process.zero_point", "_generated_mul_23.activation_post_process.activation_post_process.eps", "_generated_mul_23.activation_post_process.activation_post_process.min_val", "_generated_mul_23.activation_post_process.activation_post_process.max_val", "_generated___setitem___13.activation_post_process.fake_quant_enabled", "_generated___setitem___13.activation_post_process.observer_enabled", "_generated___setitem___13.activation_post_process.scale", "_generated___setitem___13.activation_post_process.zero_point", "_generated___setitem___13.activation_post_process.activation_post_process.eps", "_generated___setitem___13.activation_post_process.activation_post_process.min_val", "_generated___setitem___13.activation_post_process.activation_post_process.max_val", "_generated_mul_24.activation_post_process.fake_quant_enabled", "_generated_mul_24.activation_post_process.observer_enabled", "_generated_mul_24.activation_post_process.scale", "_generated_mul_24.activation_post_process.zero_point", "_generated_mul_24.activation_post_process.activation_post_process.eps", "_generated_mul_24.activation_post_process.activation_post_process.min_val", "_generated_mul_24.activation_post_process.activation_post_process.max_val", "_generated___setitem___14.activation_post_process.fake_quant_enabled", "_generated___setitem___14.activation_post_process.observer_enabled", "_generated___setitem___14.activation_post_process.scale", "_generated___setitem___14.activation_post_process.zero_point", "_generated___setitem___14.activation_post_process.activation_post_process.eps", "_generated___setitem___14.activation_post_process.activation_post_process.min_val", "_generated___setitem___14.activation_post_process.activation_post_process.max_val", "_generated_mul_25.activation_post_process.fake_quant_enabled", "_generated_mul_25.activation_post_process.observer_enabled", "_generated_mul_25.activation_post_process.scale", "_generated_mul_25.activation_post_process.zero_point", "_generated_mul_25.activation_post_process.activation_post_process.eps", "_generated_mul_25.activation_post_process.activation_post_process.min_val", "_generated_mul_25.activation_post_process.activation_post_process.max_val", "_generated___setitem___15.activation_post_process.fake_quant_enabled", "_generated___setitem___15.activation_post_process.observer_enabled", "_generated___setitem___15.activation_post_process.scale", "_generated___setitem___15.activation_post_process.zero_point", "_generated___setitem___15.activation_post_process.activation_post_process.eps", "_generated___setitem___15.activation_post_process.activation_post_process.min_val", "_generated___setitem___15.activation_post_process.activation_post_process.max_val", "_generated_mul_26.activation_post_process.fake_quant_enabled", "_generated_mul_26.activation_post_process.observer_enabled", "_generated_mul_26.activation_post_process.scale", "_generated_mul_26.activation_post_process.zero_point", "_generated_mul_26.activation_post_process.activation_post_process.eps", "_generated_mul_26.activation_post_process.activation_post_process.min_val", "_generated_mul_26.activation_post_process.activation_post_process.max_val", "_generated___setitem___16.activation_post_process.fake_quant_enabled", "_generated___setitem___16.activation_post_process.observer_enabled", "_generated___setitem___16.activation_post_process.scale", "_generated___setitem___16.activation_post_process.zero_point", "_generated___setitem___16.activation_post_process.activation_post_process.eps", "_generated___setitem___16.activation_post_process.activation_post_process.min_val", "_generated___setitem___16.activation_post_process.activation_post_process.max_val", "_generated_mul_27.activation_post_process.fake_quant_enabled", "_generated_mul_27.activation_post_process.observer_enabled", "_generated_mul_27.activation_post_process.scale", "_generated_mul_27.activation_post_process.zero_point", "_generated_mul_27.activation_post_process.activation_post_process.eps", "_generated_mul_27.activation_post_process.activation_post_process.min_val", "_generated_mul_27.activation_post_process.activation_post_process.max_val", "_generated_sum_0.activation_post_process.fake_quant_enabled", "_generated_sum_0.activation_post_process.observer_enabled", "_generated_sum_0.activation_post_process.scale", "_generated_sum_0.activation_post_process.zero_point", "_generated_sum_0.activation_post_process.activation_post_process.eps", "_generated_sum_0.activation_post_process.activation_post_process.min_val", "_generated_sum_0.activation_post_process.activation_post_process.max_val", "_generated_div_2.reciprocal.reciprocal.activation_post_process.fake_quant_enabled", "_generated_div_2.reciprocal.reciprocal.activation_post_process.observer_enabled", "_generated_div_2.reciprocal.reciprocal.activation_post_process.scale", "_generated_div_2.reciprocal.reciprocal.activation_post_process.zero_point", "_generated_div_2.reciprocal.reciprocal.activation_post_process.activation_post_process.eps", "_generated_div_2.reciprocal.reciprocal.activation_post_process.activation_post_process.min_val", "_generated_div_2.reciprocal.reciprocal.activation_post_process.activation_post_process.max_val", "_generated_div_2.mul.activation_post_process.fake_quant_enabled", "_generated_div_2.mul.activation_post_process.observer_enabled", "_generated_div_2.mul.activation_post_process.scale", "_generated_div_2.mul.activation_post_process.zero_point", "_generated_div_2.mul.activation_post_process.activation_post_process.eps", "_generated_div_2.mul.activation_post_process.activation_post_process.min_val", "_generated_div_2.mul.activation_post_process.activation_post_process.max_val", "_generated_mul_28.activation_post_process.fake_quant_enabled", "_generated_mul_28.activation_post_process.observer_enabled", "_generated_mul_28.activation_post_process.scale", "_generated_mul_28.activation_post_process.zero_point", "_generated_mul_28.activation_post_process.activation_post_process.eps", "_generated_mul_28.activation_post_process.activation_post_process.min_val", "_generated_mul_28.activation_post_process.activation_post_process.max_val", "_generated_sum_1.activation_post_process.fake_quant_enabled", "_generated_sum_1.activation_post_process.observer_enabled", "_generated_sum_1.activation_post_process.scale", "_generated_sum_1.activation_post_process.zero_point", "_generated_sum_1.activation_post_process.activation_post_process.eps", "_generated_sum_1.activation_post_process.activation_post_process.min_val", "_generated_sum_1.activation_post_process.activation_post_process.max_val", "_generated_div_3.reciprocal.reciprocal.activation_post_process.fake_quant_enabled", "_generated_div_3.reciprocal.reciprocal.activation_post_process.observer_enabled", "_generated_div_3.reciprocal.reciprocal.activation_post_process.scale", "_generated_div_3.reciprocal.reciprocal.activation_post_process.zero_point", "_generated_div_3.reciprocal.reciprocal.activation_post_process.activation_post_process.eps", "_generated_div_3.reciprocal.reciprocal.activation_post_process.activation_post_process.min_val", "_generated_div_3.reciprocal.reciprocal.activation_post_process.activation_post_process.max_val", "_generated_div_3.mul.activation_post_process.fake_quant_enabled", "_generated_div_3.mul.activation_post_process.observer_enabled", "_generated_div_3.mul.activation_post_process.scale", "_generated_div_3.mul.activation_post_process.zero_point", "_generated_div_3.mul.activation_post_process.activation_post_process.eps", "_generated_div_3.mul.activation_post_process.activation_post_process.min_val", "_generated_div_3.mul.activation_post_process.activation_post_process.max_val", "_generated_mul_29.activation_post_process.fake_quant_enabled", "_generated_mul_29.activation_post_process.observer_enabled", "_generated_mul_29.activation_post_process.scale", "_generated_mul_29.activation_post_process.zero_point", "_generated_mul_29.activation_post_process.activation_post_process.eps", "_generated_mul_29.activation_post_process.activation_post_process.min_val", "_generated_mul_29.activation_post_process.activation_post_process.max_val", "_generated_add_3.activation_post_process.fake_quant_enabled", "_generated_add_3.activation_post_process.observer_enabled", "_generated_add_3.activation_post_process.scale", "_generated_add_3.activation_post_process.zero_point", "_generated_add_3.activation_post_process.activation_post_process.eps", "_generated_add_3.activation_post_process.activation_post_process.min_val", "_generated_add_3.activation_post_process.activation_post_process.max_val", "_generated_add_4.activation_post_process.fake_quant_enabled", "_generated_add_4.activation_post_process.observer_enabled", "_generated_add_4.activation_post_process.scale", "_generated_add_4.activation_post_process.zero_point", "_generated_add_4.activation_post_process.activation_post_process.eps", "_generated_add_4.activation_post_process.activation_post_process.min_val", "_generated_add_4.activation_post_process.activation_post_process.max_val", "_generated_scatter_1.activation_pre_process.0.fake_quant_enabled", "_generated_scatter_1.activation_pre_process.0.observer_enabled", "_generated_scatter_1.activation_pre_process.0.scale", "_generated_scatter_1.activation_pre_process.0.zero_point", "_generated_scatter_1.activation_pre_process.0.activation_post_process.eps", "_generated_scatter_1.activation_pre_process.0.activation_post_process.min_val", "_generated_scatter_1.activation_pre_process.0.activation_post_process.max_val", "_generated_scatter_1.activation_post_process.fake_quant_enabled", "_generated_scatter_1.activation_post_process.observer_enabled", "_generated_scatter_1.activation_post_process.scale", "_generated_scatter_1.activation_post_process.zero_point", "_generated_scatter_1.activation_post_process.activation_post_process.eps", "_generated_scatter_1.activation_post_process.activation_post_process.min_val", "_generated_scatter_1.activation_post_process.activation_post_process.max_val", "_generated_sum_2.activation_post_process.fake_quant_enabled", "_generated_sum_2.activation_post_process.observer_enabled", "_generated_sum_2.activation_post_process.scale", "_generated_sum_2.activation_post_process.zero_point", "_generated_sum_2.activation_post_process.activation_post_process.eps", "_generated_sum_2.activation_post_process.activation_post_process.min_val", "_generated_sum_2.activation_post_process.activation_post_process.max_val", "_generated_div_4.reciprocal.reciprocal.activation_post_process.fake_quant_enabled", "_generated_div_4.reciprocal.reciprocal.activation_post_process.observer_enabled", "_generated_div_4.reciprocal.reciprocal.activation_post_process.scale", "_generated_div_4.reciprocal.reciprocal.activation_post_process.zero_point", "_generated_div_4.reciprocal.reciprocal.activation_post_process.activation_post_process.eps", "_generated_div_4.reciprocal.reciprocal.activation_post_process.activation_post_process.min_val", "_generated_div_4.reciprocal.reciprocal.activation_post_process.activation_post_process.max_val", "_generated_div_4.mul.activation_post_process.fake_quant_enabled", "_generated_div_4.mul.activation_post_process.observer_enabled", "_generated_div_4.mul.activation_post_process.scale", "_generated_div_4.mul.activation_post_process.zero_point", "_generated_div_4.mul.activation_post_process.activation_post_process.eps", "_generated_div_4.mul.activation_post_process.activation_post_process.min_val", "_generated_div_4.mul.activation_post_process.activation_post_process.max_val", "_generated_mul_30.activation_post_process.fake_quant_enabled", "_generated_mul_30.activation_post_process.observer_enabled", "_generated_mul_30.activation_post_process.scale", "_generated_mul_30.activation_post_process.zero_point", "_generated_mul_30.activation_post_process.activation_post_process.eps", "_generated_mul_30.activation_post_process.activation_post_process.min_val", "_generated_mul_30.activation_post_process.activation_post_process.max_val", "_generated___setitem___17.activation_post_process.fake_quant_enabled", "_generated___setitem___17.activation_post_process.observer_enabled", "_generated___setitem___17.activation_post_process.scale", "_generated___setitem___17.activation_post_process.zero_point", "_generated___setitem___17.activation_post_process.activation_post_process.eps", "_generated___setitem___17.activation_post_process.activation_post_process.min_val", "_generated___setitem___17.activation_post_process.activation_post_process.max_val", "_generated_mul_31.activation_post_process.fake_quant_enabled", "_generated_mul_31.activation_post_process.observer_enabled", "_generated_mul_31.activation_post_process.scale", "_generated_mul_31.activation_post_process.zero_point", "_generated_mul_31.activation_post_process.activation_post_process.eps", "_generated_mul_31.activation_post_process.activation_post_process.min_val", "_generated_mul_31.activation_post_process.activation_post_process.max_val", "_generated___setitem___18.activation_post_process.fake_quant_enabled", "_generated___setitem___18.activation_post_process.observer_enabled", "_generated___setitem___18.activation_post_process.scale", "_generated___setitem___18.activation_post_process.zero_point", "_generated___setitem___18.activation_post_process.activation_post_process.eps", "_generated___setitem___18.activation_post_process.activation_post_process.min_val", "_generated___setitem___18.activation_post_process.activation_post_process.max_val", "_generated_mul_32.activation_post_process.fake_quant_enabled", "_generated_mul_32.activation_post_process.observer_enabled", "_generated_mul_32.activation_post_process.scale", "_generated_mul_32.activation_post_process.zero_point", "_generated_mul_32.activation_post_process.activation_post_process.eps", "_generated_mul_32.activation_post_process.activation_post_process.min_val", "_generated_mul_32.activation_post_process.activation_post_process.max_val", "_generated___setitem___19.activation_post_process.fake_quant_enabled", "_generated___setitem___19.activation_post_process.observer_enabled", "_generated___setitem___19.activation_post_process.scale", "_generated___setitem___19.activation_post_process.zero_point", "_generated___setitem___19.activation_post_process.activation_post_process.eps", "_generated___setitem___19.activation_post_process.activation_post_process.min_val", "_generated___setitem___19.activation_post_process.activation_post_process.max_val", "_generated_mul_33.activation_post_process.fake_quant_enabled", "_generated_mul_33.activation_post_process.observer_enabled", "_generated_mul_33.activation_post_process.scale", "_generated_mul_33.activation_post_process.zero_point", "_generated_mul_33.activation_post_process.activation_post_process.eps", "_generated_mul_33.activation_post_process.activation_post_process.min_val", "_generated_mul_33.activation_post_process.activation_post_process.max_val", "_generated___setitem___20.activation_post_process.fake_quant_enabled", "_generated___setitem___20.activation_post_process.observer_enabled", "_generated___setitem___20.activation_post_process.scale", "_generated___setitem___20.activation_post_process.zero_point", "_generated___setitem___20.activation_post_process.activation_post_process.eps", "_generated___setitem___20.activation_post_process.activation_post_process.min_val", "_generated___setitem___20.activation_post_process.activation_post_process.max_val", "_generated_mul_34.activation_post_process.fake_quant_enabled", "_generated_mul_34.activation_post_process.observer_enabled", "_generated_mul_34.activation_post_process.scale", "_generated_mul_34.activation_post_process.zero_point", "_generated_mul_34.activation_post_process.activation_post_process.eps", "_generated_mul_34.activation_post_process.activation_post_process.min_val", "_generated_mul_34.activation_post_process.activation_post_process.max_val", "_generated___setitem___21.activation_post_process.fake_quant_enabled", "_generated___setitem___21.activation_post_process.observer_enabled", "_generated___setitem___21.activation_post_process.scale", "_generated___setitem___21.activation_post_process.zero_point", "_generated___setitem___21.activation_post_process.activation_post_process.eps", "_generated___setitem___21.activation_post_process.activation_post_process.min_val", "_generated___setitem___21.activation_post_process.activation_post_process.max_val", "_generated_mul_35.activation_post_process.fake_quant_enabled", "_generated_mul_35.activation_post_process.observer_enabled", "_generated_mul_35.activation_post_process.scale", "_generated_mul_35.activation_post_process.zero_point", "_generated_mul_35.activation_post_process.activation_post_process.eps", "_generated_mul_35.activation_post_process.activation_post_process.min_val", "_generated_mul_35.activation_post_process.activation_post_process.max_val", "_generated___setitem___22.activation_post_process.fake_quant_enabled", "_generated___setitem___22.activation_post_process.observer_enabled", "_generated___setitem___22.activation_post_process.scale", "_generated___setitem___22.activation_post_process.zero_point", "_generated___setitem___22.activation_post_process.activation_post_process.eps", "_generated___setitem___22.activation_post_process.activation_post_process.min_val", "_generated___setitem___22.activation_post_process.activation_post_process.max_val", "_generated_mul_36.activation_post_process.fake_quant_enabled", "_generated_mul_36.activation_post_process.observer_enabled", "_generated_mul_36.activation_post_process.scale", "_generated_mul_36.activation_post_process.zero_point", "_generated_mul_36.activation_post_process.activation_post_process.eps", "_generated_mul_36.activation_post_process.activation_post_process.min_val", "_generated_mul_36.activation_post_process.activation_post_process.max_val", "_generated___setitem___23.activation_post_process.fake_quant_enabled", "_generated___setitem___23.activation_post_process.observer_enabled", "_generated___setitem___23.activation_post_process.scale", "_generated___setitem___23.activation_post_process.zero_point", "_generated___setitem___23.activation_post_process.activation_post_process.eps", "_generated___setitem___23.activation_post_process.activation_post_process.min_val", "_generated___setitem___23.activation_post_process.activation_post_process.max_val", "_generated_mul_37.activation_post_process.fake_quant_enabled", "_generated_mul_37.activation_post_process.observer_enabled", "_generated_mul_37.activation_post_process.scale", "_generated_mul_37.activation_post_process.zero_point", "_generated_mul_37.activation_post_process.activation_post_process.eps", "_generated_mul_37.activation_post_process.activation_post_process.min_val", "_generated_mul_37.activation_post_process.activation_post_process.max_val", "_generated___setitem___24.activation_post_process.fake_quant_enabled", "_generated___setitem___24.activation_post_process.observer_enabled", "_generated___setitem___24.activation_post_process.scale", "_generated___setitem___24.activation_post_process.zero_point", "_generated___setitem___24.activation_post_process.activation_post_process.eps", "_generated___setitem___24.activation_post_process.activation_post_process.min_val", "_generated___setitem___24.activation_post_process.activation_post_process.max_val", "_generated_mul_38.activation_post_process.fake_quant_enabled", "_generated_mul_38.activation_post_process.observer_enabled", "_generated_mul_38.activation_post_process.scale", "_generated_mul_38.activation_post_process.zero_point", "_generated_mul_38.activation_post_process.activation_post_process.eps", "_generated_mul_38.activation_post_process.activation_post_process.min_val", "_generated_mul_38.activation_post_process.activation_post_process.max_val", "_generated_sum_3.activation_post_process.fake_quant_enabled", "_generated_sum_3.activation_post_process.observer_enabled", "_generated_sum_3.activation_post_process.scale", "_generated_sum_3.activation_post_process.zero_point", "_generated_sum_3.activation_post_process.activation_post_process.eps", "_generated_sum_3.activation_post_process.activation_post_process.min_val", "_generated_sum_3.activation_post_process.activation_post_process.max_val", "_generated_div_5.reciprocal.reciprocal.activation_post_process.fake_quant_enabled", "_generated_div_5.reciprocal.reciprocal.activation_post_process.observer_enabled", "_generated_div_5.reciprocal.reciprocal.activation_post_process.scale", "_generated_div_5.reciprocal.reciprocal.activation_post_process.zero_point", "_generated_div_5.reciprocal.reciprocal.activation_post_process.activation_post_process.eps", "_generated_div_5.reciprocal.reciprocal.activation_post_process.activation_post_process.min_val", "_generated_div_5.reciprocal.reciprocal.activation_post_process.activation_post_process.max_val", "_generated_div_5.mul.activation_post_process.fake_quant_enabled", "_generated_div_5.mul.activation_post_process.observer_enabled", "_generated_div_5.mul.activation_post_process.scale", "_generated_div_5.mul.activation_post_process.zero_point", "_generated_div_5.mul.activation_post_process.activation_post_process.eps", "_generated_div_5.mul.activation_post_process.activation_post_process.min_val", "_generated_div_5.mul.activation_post_process.activation_post_process.max_val", "_generated_mul_39.activation_post_process.fake_quant_enabled", "_generated_mul_39.activation_post_process.observer_enabled", "_generated_mul_39.activation_post_process.scale", "_generated_mul_39.activation_post_process.zero_point", "_generated_mul_39.activation_post_process.activation_post_process.eps", "_generated_mul_39.activation_post_process.activation_post_process.min_val", "_generated_mul_39.activation_post_process.activation_post_process.max_val", "_generated_add_5.activation_post_process.fake_quant_enabled", "_generated_add_5.activation_post_process.observer_enabled", "_generated_add_5.activation_post_process.scale", "_generated_add_5.activation_post_process.zero_point", "_generated_add_5.activation_post_process.activation_post_process.eps", "_generated_add_5.activation_post_process.activation_post_process.min_val", "_generated_add_5.activation_post_process.activation_post_process.max_val", "_generated_add_6.activation_post_process.fake_quant_enabled", "_generated_add_6.activation_post_process.observer_enabled", "_generated_add_6.activation_post_process.scale", "_generated_add_6.activation_post_process.zero_point", "_generated_add_6.activation_post_process.activation_post_process.eps", "_generated_add_6.activation_post_process.activation_post_process.min_val", "_generated_add_6.activation_post_process.activation_post_process.max_val", "vfe._generated_sum_0.activation_post_process.fake_quant_enabled", "vfe._generated_sum_0.activation_post_process.observer_enabled", "vfe._generated_sum_0.activation_post_process.scale", "vfe._generated_sum_0.activation_post_process.zero_point", "vfe._generated_sum_0.activation_post_process.activation_post_process.eps", "vfe._generated_sum_0.activation_post_process.activation_post_process.min_val", "vfe._generated_sum_0.activation_post_process.activation_post_process.max_val", "vfe._generated_div_0.reciprocal.reciprocal.activation_post_process.fake_quant_enabled", "vfe._generated_div_0.reciprocal.reciprocal.activation_post_process.observer_enabled", "vfe._generated_div_0.reciprocal.reciprocal.activation_post_process.scale", "vfe._generated_div_0.reciprocal.reciprocal.activation_post_process.zero_point", "vfe._generated_div_0.reciprocal.reciprocal.activation_post_process.activation_post_process.eps", "vfe._generated_div_0.reciprocal.reciprocal.activation_post_process.activation_post_process.min_val", "vfe._generated_div_0.reciprocal.reciprocal.activation_post_process.activation_post_process.max_val", "vfe._generated_div_0.mul.activation_post_process.fake_quant_enabled", "vfe._generated_div_0.mul.activation_post_process.observer_enabled", "vfe._generated_div_0.mul.activation_post_process.scale", "vfe._generated_div_0.mul.activation_post_process.zero_point", "vfe._generated_div_0.mul.activation_post_process.activation_post_process.eps", "vfe._generated_div_0.mul.activation_post_process.activation_post_process.min_val", "vfe._generated_div_0.mul.activation_post_process.activation_post_process.max_val", "vfe._generated_sub_0.activation_post_process.fake_quant_enabled", "vfe._generated_sub_0.activation_post_process.observer_enabled", "vfe._generated_sub_0.activation_post_process.scale", "vfe._generated_sub_0.activation_post_process.zero_point", "vfe._generated_sub_0.activation_post_process.activation_post_process.eps", "vfe._generated_sub_0.activation_post_process.activation_post_process.min_val", "vfe._generated_sub_0.activation_post_process.activation_post_process.max_val", "vfe._generated_mul_0.activation_post_process.fake_quant_enabled", "vfe._generated_mul_0.activation_post_process.observer_enabled", "vfe._generated_mul_0.activation_post_process.scale", "vfe._generated_mul_0.activation_post_process.zero_point", "vfe._generated_mul_0.activation_post_process.activation_post_process.eps", "vfe._generated_mul_0.activation_post_process.activation_post_process.min_val", "vfe._generated_mul_0.activation_post_process.activation_post_process.max_val", "vfe._generated_add_0.activation_post_process.fake_quant_enabled", "vfe._generated_add_0.activation_post_process.observer_enabled", "vfe._generated_add_0.activation_post_process.scale", "vfe._generated_add_0.activation_post_process.zero_point", "vfe._generated_add_0.activation_post_process.activation_post_process.eps", "vfe._generated_add_0.activation_post_process.activation_post_process.min_val", "vfe._generated_add_0.activation_post_process.activation_post_process.max_val", "vfe._generated_sub_1.activation_post_process.fake_quant_enabled", "vfe._generated_sub_1.activation_post_process.observer_enabled", "vfe._generated_sub_1.activation_post_process.scale", "vfe._generated_sub_1.activation_post_process.zero_point", "vfe._generated_sub_1.activation_post_process.activation_post_process.eps", "vfe._generated_sub_1.activation_post_process.activation_post_process.min_val", "vfe._generated_sub_1.activation_post_process.activation_post_process.max_val", "vfe._generated___setitem___0.activation_post_process.fake_quant_enabled", "vfe._generated___setitem___0.activation_post_process.observer_enabled", "vfe._generated___setitem___0.activation_post_process.scale", "vfe._generated___setitem___0.activation_post_process.zero_point", "vfe._generated___setitem___0.activation_post_process.activation_post_process.eps", "vfe._generated___setitem___0.activation_post_process.activation_post_process.min_val", "vfe._generated___setitem___0.activation_post_process.activation_post_process.max_val", "vfe._generated_mul_1.activation_post_process.fake_quant_enabled", "vfe._generated_mul_1.activation_post_process.observer_enabled", "vfe._generated_mul_1.activation_post_process.scale", "vfe._generated_mul_1.activation_post_process.zero_point", "vfe._generated_mul_1.activation_post_process.activation_post_process.eps", "vfe._generated_mul_1.activation_post_process.activation_post_process.min_val", "vfe._generated_mul_1.activation_post_process.activation_post_process.max_val", "vfe._generated_add_1.activation_post_process.fake_quant_enabled", "vfe._generated_add_1.activation_post_process.observer_enabled", "vfe._generated_add_1.activation_post_process.scale", "vfe._generated_add_1.activation_post_process.zero_point", "vfe._generated_add_1.activation_post_process.activation_post_process.eps", "vfe._generated_add_1.activation_post_process.activation_post_process.min_val", "vfe._generated_add_1.activation_post_process.activation_post_process.max_val", "vfe._generated_sub_2.activation_post_process.fake_quant_enabled", "vfe._generated_sub_2.activation_post_process.observer_enabled", "vfe._generated_sub_2.activation_post_process.scale", "vfe._generated_sub_2.activation_post_process.zero_point", "vfe._generated_sub_2.activation_post_process.activation_post_process.eps", "vfe._generated_sub_2.activation_post_process.activation_post_process.min_val", "vfe._generated_sub_2.activation_post_process.activation_post_process.max_val", "vfe._generated___setitem___1.activation_post_process.fake_quant_enabled", "vfe._generated___setitem___1.activation_post_process.observer_enabled", "vfe._generated___setitem___1.activation_post_process.scale", "vfe._generated___setitem___1.activation_post_process.zero_point", "vfe._generated___setitem___1.activation_post_process.activation_post_process.eps", "vfe._generated___setitem___1.activation_post_process.activation_post_process.min_val", "vfe._generated___setitem___1.activation_post_process.activation_post_process.max_val", "vfe._generated_cat_0.activation_post_process.fake_quant_enabled", "vfe._generated_cat_0.activation_post_process.observer_enabled", "vfe._generated_cat_0.activation_post_process.scale", "vfe._generated_cat_0.activation_post_process.zero_point", "vfe._generated_cat_0.activation_post_process.activation_post_process.eps", "vfe._generated_cat_0.activation_post_process.activation_post_process.min_val", "vfe._generated_cat_0.activation_post_process.activation_post_process.max_val", "vfe._generated_mul_2.activation_post_process.fake_quant_enabled", "vfe._generated_mul_2.activation_post_process.observer_enabled", "vfe._generated_mul_2.activation_post_process.scale", "vfe._generated_mul_2.activation_post_process.zero_point", "vfe._generated_mul_2.activation_post_process.activation_post_process.eps", "vfe._generated_mul_2.activation_post_process.activation_post_process.min_val", "vfe._generated_mul_2.activation_post_process.activation_post_process.max_val"]:
                continue
            if weight_name_new in ["map_to_bev_module._generated_stack_0.activation_post_process.fake_quant_enabled", "map_to_bev_module._generated_stack_0.activation_post_process.observer_enabled", "map_to_bev_module._generated_stack_0.activation_post_process.scale", "map_to_bev_module._generated_stack_0.activation_post_process.zero_point", "map_to_bev_module._generated_stack_0.activation_post_process.activation_post_process.eps", "map_to_bev_module._generated_stack_0.activation_post_process.activation_post_process.min_val", "map_to_bev_module._generated_stack_0.activation_post_process.activation_post_process.max_val"]:
                continue
            if weight_name_new in ["_generated_stack_0.activation_post_process.fake_quant_enabled", "_generated_stack_0.activation_post_process.observer_enabled", "_generated_stack_0.activation_post_process.scale", "_generated_stack_0.activation_post_process.zero_point", "_generated_stack_0.activation_post_process.activation_post_process.eps", "_generated_stack_0.activation_post_process.activation_post_process.min_val", "_generated_stack_0.activation_post_process.activation_post_process.max_val"]:
                continue

            state_dict_calib_new[weight_name_new] = state_dict_calib[weight_name]
        # import ipdb; ipdb.set_trace()
        with open(f"logs/q_model_{cur_time}.txt", "w") as f:
            # 模型当前 state_dict
            f.write("=== self.q_model.state_dict ===\n")
            for k, v in self.q_model.state_dict().items():
                f.write(f"{k}: {tuple(v.shape)}\n")
        with open(f"logs/state_dict_calib_new_{cur_time}.txt", "w") as f:
            f.write("\n=== state_dict_calib_new ===\n")
            for k, v in state_dict_calib_new.items():
                f.write(f"{k}: {tuple(v.shape)}\n")
        self.q_model.load_state_dict(state_dict_calib_new)
        self.q_model.cuda()
        self.q_model.eval()
        hbir_model = hb4.export(self.q_model, example_inputs_dataloader, input_names=input_names, output_names=output_names)
        save(hbir_model, os.path.join(self.save_dir, "{}_{}.bc".format(cur_time, model_name)))
        visualize(hbir_model, os.path.join(self.save_dir, "{}_{}.bc.onnx".format(cur_time, model_name)))

        quantized_hbir_model = convert(hbir_model, march, advice=True, advice_path=os.path.join(self.save_dir, 'op_check_'), enable_vpu=True)
        save(quantized_hbir_model, os.path.join(self.save_dir, "{}_{}_quantized.bc".format(cur_time, model_name)))
        visualize(quantized_hbir_model, os.path.join(self.save_dir, "{}_{}_quantized.bc.onnx".format(cur_time, model_name)))       
        print("start compile ")
        params = {'debug':True, 'jobs': 32, 'balance': 0, 'progress_bar': True, 'opt': 2,'input_no_padding':True,'output_no_padding':True}
        compile(quantized_hbir_model, os.path.join(self.save_dir, "{}_{}.hbm".format(cur_time, model_name)), march, **params)
        perf_save_dir = os.path.join(self.save_dir, "{}_{}.hbm.perf".format(cur_time, model_name))
        os.makedirs(perf_save_dir, exist_ok=True)
        hbm_perf(os.path.join(self.save_dir, "{}_{}.hbm".format(cur_time, model_name)), 
                 perf_save_dir)
        
        # print("------------- removequan ----------------")
        
        # func = quantized_hbir_model.functions[0]
        # func.remove_io_op(op_types=["Quantize", "Dequantize"]) 
        # save(quantized_hbir_model, os.path.join(self.save_dir, "{}_quantized_removequan.bc".format(model_name)))
        # visualize(quantized_hbir_model, os.path.join(self.save_dir, "{}_quantized_removequan.bc.onnx".format(model_name)))            
        # print("strat compile ")
        # params = {'debug':True, 'jobs': 32, 'balance': 100, 'progress_bar': True, 'opt': 2,'input_no_padding':True,'output_no_padding':True}
        # compile(quantized_hbir_model, os.path.join(self.save_dir, "{}_removequan.hbm".format(model_name)), march, **params)
        # hbm_perf(os.path.join(self.save_dir, "{}_removequan.hbm".format(model_name)), 
        #          self.save_dir)

def main():
    args, cfg = parse_config()

    if args.infer_time:
        os.environ['CUDA_LAUNCH_BLOCKING'] = '1'

    if args.launcher == 'none':
        dist_test = False
        total_gpus = 1
    else:
        total_gpus, cfg.LOCAL_RANK = getattr(common_utils, 'init_dist_%s' % args.launcher)(
            args.tcp_port, args.local_rank, backend='nccl'
        )
        dist_test = True

    if args.batch_size is None:
        args.batch_size = cfg.OPTIMIZATION.BATCH_SIZE_PER_GPU
    else:
        assert args.batch_size % total_gpus == 0, 'Batch size should match the number of gpus'
        args.batch_size = args.batch_size // total_gpus

    output_dir = cfg.ROOT_DIR / args.output_folder / cfg.EXP_GROUP_PATH / cfg.TAG / args.extra_tag
    output_dir.mkdir(parents=True, exist_ok=True)

    qat_output_dir = output_dir / 'qat'

    num_list = re.findall(r'\d+', args.ckpt) if args.ckpt is not None else []
    epoch_id = num_list[-1] if num_list.__len__() > 0 else 'no_number'
    qat_output_dir = qat_output_dir / ('epoch_%s' % epoch_id)

    qat_output_dir.mkdir(parents=True, exist_ok=True)
    log_file = qat_output_dir / ('log_compile_%s.txt' % datetime.datetime.now().strftime('%Y%m%d-%H%M%S'))
    logger = common_utils.create_logger(log_file, rank=cfg.LOCAL_RANK)

    # log to file
    logger.info('**********************Start logging**********************')
    gpu_list = os.environ['CUDA_VISIBLE_DEVICES'] if 'CUDA_VISIBLE_DEVICES' in os.environ.keys() else 'ALL'
    logger.info('CUDA_VISIBLE_DEVICES=%s' % gpu_list)

    if dist_test:
        logger.info('total_batch_size: %d' % (total_gpus * args.batch_size))
    for key, val in vars(args).items():
        logger.info('{:16} {}'.format(key, val))
    log_config_to_file(cfg, logger=logger)

    test_set, test_loader, sampler = build_dataloader(
        dataset_cfg=cfg.DATA_CONFIG,
        class_names=cfg.CLASS_NAMES,
        batch_size=args.batch_size,
        dist=dist_test, workers=args.workers, logger=logger, training=False
    )

    train_set, train_loader, train_sampler = build_dataloader(
        dataset_cfg=cfg.DATA_CONFIG,
        class_names=cfg.CLASS_NAMES,
        batch_size=args.batch_size,
        dist=dist_test, workers=args.workers,
        logger=logger,
        training=True,
        merge_all_iters_to_one_epoch=False,
        total_epochs=1,
        seed=None
    )

    # model = build_network(model_cfg=cfg.MODEL, num_class=len(cfg.CLASS_NAMES), dataset=test_set)
    # if args.sync_bn:
    #     model = torch.nn.SyncBatchNorm.convert_sync_batchnorm(model)

    '''
    compile
    '''
    max_iter=2000
    qat_pth_path = os.path.join(qat_output_dir, "calib-max_iter_{}-state_dict.pth".format(max_iter))
    print("qat_pth_path", qat_pth_path)
    lidar_branch_module_list = ['PillarVFEQat', 'PointPillarScatter_Seg_Qat']
    input_names = ['vfe_input', 'voxel_coords']
    output_names = ['spatial_features']
    task="lidar"
    helper = ModelCompiler(qat_output_dir, cfg, fuse_conv_bn_flag=False)
    helper.process(qat_pth_path, train_loader, lidar_branch_module_list, input_names, output_names, task, model_name="vfe-scatter")

    # do_prepare = True
    # do_compile = True
    # helper.process(qat_pth_path, do_prepare, do_compile)

    return


if __name__ == '__main__':
    main()

# python tools/compile_spetr_pvb_head.py --config projects/configs/STChery-PVB-GOP-DoubleHead/cruise_head_qat.py --checkpoint work_dirs/STChery-PVB/spetr_dla34v3_4p4f_v7.1.1_road_PVB_2025_04_07_T0/PVB=iter_15115_copy_GOP=iter_39012_double_for_qat.pth